<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Allure Projects</title>

    <style>
        :root{
            --bg:#0b1220;
            --panel:rgba(255,255,255,.06);
            --border:rgba(255,255,255,.12);
            --text:rgba(255,255,255,.92);
            --muted:rgba(255,255,255,.65);
            --good:#2ecc71;
            --bad:#ff5a5f;
            --warn:#ffb020;
            --btn:rgba(255,255,255,.10);
            --btn2:rgba(255,255,255,.16);
            --shadow:0 12px 30px rgba(0,0,0,.35);
            --r:16px;
        }

        /* ===== Animated glass background ===== */
        body{
            margin:0;
            font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
            background:#0b1220;
            color:var(--text);
            overflow-x:hidden;
        }
        .bg{
            position:fixed;
            inset:0;
            z-index:-2;
            overflow:hidden;
            background:#0b1220;
        }
        .blob{
            position:absolute;
            width:560px;
            height:560px;
            border-radius:999px;
            filter:blur(60px);
            opacity:.72;
            animation:floaty 24s ease-in-out infinite;
            transform:translate3d(0,0,0);
            will-change:transform;
        }
        .b1{left:-160px;top:-170px;background:radial-gradient(circle at 30% 30%, rgba(88,101,242,.95), rgba(88,101,242,.12) 60%, transparent 72%);}
        .b2{right:-200px;top:-160px;background:radial-gradient(circle at 35% 35%, rgba(46,204,113,.9), rgba(46,204,113,.12) 60%, transparent 72%);animation-duration:28s;animation-delay:-7s;}
        .b3{left:18%;bottom:-260px;width:820px;height:820px;background:radial-gradient(circle at 40% 40%, rgba(255,90,95,.45), transparent 70%);animation-duration:32s;animation-delay:-12s;opacity:.52;}
        @keyframes floaty{
            0%{transform:translate(-2%,-1%) scale(1);}
            25%{transform:translate(4%,2%) scale(1.05);}
            50%{transform:translate(2%,6%) scale(.98);}
            75%{transform:translate(-3%,3%) scale(1.03);}
            100%{transform:translate(-2%,-1%) scale(1);}
        }
        .noise{
            position:absolute;
            inset:0;
            opacity:.08;
            pointer-events:none;
            background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.6'/%3E%3C/svg%3E");
            background-repeat:repeat;
            mix-blend-mode:overlay;
        }

        /* ===== Layout ===== */
        .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 44px;}
        .card{
            background:var(--panel);
            border:1px solid var(--border);
            border-radius:var(--r);
            padding:18px;
            box-shadow:var(--shadow);
            backdrop-filter:blur(12px) saturate(1.1);
            -webkit-backdrop-filter:blur(12px) saturate(1.1);
        }
        .top{display:grid;grid-template-columns:1fr auto;gap:14px;align-items:start;margin-bottom:18px;}
        h1{margin:0 0 6px;font-size:22px;}
        .sub{color:var(--muted);font-size:13px;}
        .stats{display:grid;grid-auto-flow:column;gap:10px;}
        .stat{min-width:160px}
        .stat .k{color:var(--muted);font-size:12px;}
        .stat .v{font-size:20px;margin-top:4px;}

        .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:16px 0 10px;}
        .search{
            background:var(--panel);
            border:1px solid var(--border);
            border-radius:14px;
            padding:12px;
            display:flex;
            align-items:center;
            gap:10px;
            backdrop-filter:blur(10px);
        }
        .search input{
            width:100%;
            border:0;
            outline:0;
            background:transparent;
            color:var(--text);
            font-size:14px;
        }
        .pill{
            font-size:12px;
            color:var(--muted);
            background:rgba(0,0,0,.18);
            border:1px solid var(--border);
            padding:6px 10px;
            border-radius:999px;
            white-space:nowrap;
        }

        .list{
            background:var(--panel);
            border:1px solid var(--border);
            border-radius:var(--r);
            box-shadow:var(--shadow);
            overflow:hidden;
            backdrop-filter:blur(12px);
        }
        .listhead{
            display:grid;
            grid-template-columns:1.2fr 0.6fr auto;
            gap:10px;
            padding:12px 14px;
            border-bottom:1px solid var(--border);
            background:rgba(0,0,0,.10);
            color:var(--muted);
            font-size:12px;
        }
        .scroll{max-height:520px;overflow:auto;}
        .item{
            display:grid;
            grid-template-columns:1.2fr 0.6fr auto;
            gap:10px;
            align-items:center;
            padding:12px 14px;
            border-bottom:1px solid rgba(255,255,255,.06);
        }
        .item:hover{background:rgba(255,255,255,.05);}

        /* project title + status inline */
        .nameRow{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }
        .name{font-weight:700;}

        /* aligned status badge */
        .badge{
            display:inline-flex;
            align-items:center;
            gap:8px;
            border-radius:999px;
            padding:6px 10px;
            font-size:12px;
            border:1px solid var(--border);
            background:rgba(0,0,0,.16);
            line-height:1;
            white-space:nowrap;
            flex:0 0 auto;
        }
        .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);flex:0 0 auto;}
        .dot.good{background:var(--good);}
        .dot.bad{background:var(--bad);}

        .meta{
            color:var(--muted);
            font-size:12px;
            margin-top:8px;
            line-height:1.35;
        }

        /* runs cell under "Runs" */
        .runsCell{
            text-align:center;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:2px;
        }
        .runsNum{
            font-size:14px;
            font-weight:700;
            color:var(--text);
        }

        /* buttons */
        .btns{display:inline-flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
        button{
            border:1px solid var(--border);
            background:var(--btn);
            color:var(--text);
            padding:8px 10px;
            border-radius:12px;
            font-size:13px;
            cursor:pointer;
            line-height:1;
        }
        button:hover{background:var(--btn2);}
        button.primary{border-color:rgba(88,101,242,.35);}
        button.primary:hover{background:rgba(88,101,242,.18);}
        button.danger{border-color:rgba(255,90,95,.35);}
        button.danger:hover{background:rgba(255,90,95,.18);}

        .toast{
            position:fixed;
            bottom:16px;
            left:50%;
            transform:translateX(-50%);
            background:rgba(0,0,0,.55);
            border:1px solid var(--border);
            color:var(--text);
            padding:10px 12px;
            border-radius:12px;
            display:none;
            box-shadow:var(--shadow);
            max-width:860px;
            white-space:pre-wrap;
        }

        @media (prefers-reduced-motion: reduce){
            .blob{animation:none;}
        }
    </style>
</head>

<body>
<div class="bg">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
    <div class="noise"></div>
</div>

<div class="wrap">
    <div class="top">
        <div class="card">
            <h1>Allure Projects</h1>
            <div class="sub">Open — страница проекта (все прогоны). Latest — последний прогон (в новой вкладке).</div>
        </div>
        <div class="stats">
            <div class="card stat"><div class="k">Projects</div><div class="v" id="statProjects">—</div></div>
            <div class="card stat"><div class="k">Runs</div><div class="v" id="statRuns">—</div></div>
        </div>
    </div>

    <div class="bar">
        <div class="search">
            <span class="pill">Search</span>
            <label for="q"></label><input id="q" placeholder="demo, backend, mobile..." />
        </div>
        <div class="pill" id="countPill">—</div>
    </div>

    <div class="list">
        <div class="listhead">
            <div>Project</div>
            <div style="text-align:center;">Runs</div>
            <div style="text-align:right;">Actions</div>
        </div>
        <div class="scroll" id="list"></div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    const elList = document.getElementById('list');
    const elQ = document.getElementById('q');
    const elStatProjects = document.getElementById('statProjects');
    const elStatRuns = document.getElementById('statRuns');
    const elCountPill = document.getElementById('countPill');
    const elToast = document.getElementById('toast');

    let data = null;

    function toast(msg){
        elToast.textContent = msg;
        elToast.style.display = 'block';
        clearTimeout(window.__t);
        window.__t = setTimeout(()=>elToast.style.display='none', 2800);
    }

    function esc(s){
        return (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function short(s, n){
        if(!s) return "";
        return s.length <= n ? s : (s.slice(0, n) + "…");
    }

    function badge(st){
        if(!st) return `<span class="badge"><span class="dot"></span>unknown</span>`;
        if(st === "success") return `<span class="badge"><span class="dot good"></span>success</span>`;
        if(st === "failed") return `<span class="badge"><span class="dot bad"></span>failed</span>`;
        return `<span class="badge"><span class="dot"></span>${esc(st)}</span>`;
    }

    function openNewTab(url){
        window.open(url, "_blank", "noopener,noreferrer");
    }

    function row(p){
        const openUrl = `/ui/${p.project}/`;
        const latestUrl = `/ui/${p.project}/latest/`;

        // ТРЕБОВАНИЕ: убрать "latest #..." — показываем только ошибку (если есть)
        const err = (p.latest_status === "failed" && p.latest_error) ? p.latest_error : "";
        const meta = err ? `<div class="meta" title="${esc(err)}">⚠ ${esc(short(err, 180))}</div>` : ``;

        const regenBtn = (p.latest_run_id && p.latest_status === "failed")
            ? `<button class="primary" data-act="regen" data-project="${p.project}" data-run="${p.latest_run_id}">Regenerate latest</button>`
            : ``;

        return `
        <div class="item">
          <div>
            <div class="nameRow">
              <div class="name">${esc(p.project)}</div>
              ${badge(p.latest_status)}
            </div>
            ${meta}
          </div>

          <div class="runsCell">
            <div class="runsNum">${p.runs_count}</div>
          </div>

          <div class="btns">
            <button data-act="open" data-url="${openUrl}">Open</button>
            <button data-act="open_tab" data-url="${latestUrl}">Latest</button>
            ${regenBtn}
            <button class="danger" data-act="del" data-project="${p.project}">Delete</button>
          </div>
        </div>`;
    }

    function render(){
        if(!data) return;
        const q = (elQ.value || "").toLowerCase().trim();
        const items = data.projects.filter(p => p.project.toLowerCase().includes(q));
        elStatProjects.textContent = data.total_projects;
        elStatRuns.textContent = data.total_runs;
        elCountPill.textContent = `${items.length} / ${data.total_projects} shown`;
        elList.innerHTML = items.map(row).join("");
    }

    async function load(){
        const r = await fetch("/api/v1/projects/summary", { headers: { accept: "application/json" } });
        if(!r.ok){
            toast("Failed to load projects summary: " + r.status);
            return;
        }
        data = await r.json();
        render();
    }

    async function doDelete(project){
        if(!confirm(`Delete project "${project}"? This will remove all runs.`)) return;
        const r = await fetch(`/api/v1/projects/${encodeURIComponent(project)}`, { method: "DELETE" });
        if(!r.ok){
            toast(`Delete failed (${r.status})`);
            return;
        }
        toast("Deleted " + project);
        await load();
    }

    async function doRegenerate(project, runId){
        const r = await fetch(`/api/v1/projects/${encodeURIComponent(project)}/runs/${runId}/regenerate`, { method: "POST" });
        const txt = await r.text();
        if(!r.ok){
            toast(`Regenerate failed (${r.status}): ${short(txt, 220)}`);
            await load();
            return;
        }
        toast(`Regenerated ${project} #${runId}`);
        await load();
    }

    elQ.addEventListener('input', render);

    document.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;

        const act = btn.getAttribute('data-act');
        if(act === "open"){
            location.href = btn.getAttribute('data-url');
            return;
        }
        if(act === "open_tab"){
            openNewTab(btn.getAttribute('data-url'));
            return;
        }
        if(act === "del"){
            doDelete(btn.getAttribute('data-project'));
            return;
        }
        if(act === "regen"){
            doRegenerate(btn.getAttribute('data-project'), btn.getAttribute('data-run'));
        }
    });

    load().catch(err => toast("Load error: " + err));
</script>
</body>
</html>
